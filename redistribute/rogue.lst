                      (         main.asm):00001         
     4000             (         main.asm):00002         SCREEN  equ $4000
                      (         main.asm):00003         
                      (         main.asm):00004                 org $0000
                      (         main.asm):00005         
0000                  (         main.asm):00006         textptr rmb 2 
0002                  (         main.asm):00007         cursor  rmb 2 ; x, y
0004                  (         main.asm):00008         origin  rmb 2 ; xorigin, yorigin
0006                  (         main.asm):00009         coords  rmb 5 ; x1, y1, x2, y2, length
                      (         main.asm):00010         
                      (         main.asm):00011                 org $E00
0E00                  (         main.asm):00012         start
                      (         main.asm):00013                 * Fast CPU
0E00 7FFFD9           (         main.asm):00014                 clr $ffd9
                      (         main.asm):00015         
                      (         main.asm):00016                 * Initialize graphics and MMU
0E03 17009B           (         main.asm):00017                 lbsr initgfx
                      (         main.asm):00018         
                      (         main.asm):00019                 * Init viewport
0E06 CC5014           (         main.asm):00020                 ldd #80*256+20
0E09 DD04             (         main.asm):00021                 std origin
0E0B CC4000           (         main.asm):00022                 ldd #SCREEN
0E0E DD00             (         main.asm):00023                 std textptr
                      (         main.asm):00024         
                      (         main.asm):00025                 * Put some sample text into the status areas
0E10 4F               (         main.asm):00026                 clra
0E11 5F               (         main.asm):00027                 clrb
0E12 17011C           (         main.asm):00028                 lbsr curspos
0E15 CE0E62           (         main.asm):00029                 ldu #line1
0E18 1700FE           (         main.asm):00030                 lbsr printline ; Status line one
0E1B 1700FB           (         main.asm):00031                 lbsr printline ; Status line one
0E1E 1700F8           (         main.asm):00032                 lbsr printline ; Status line one
0E21 4F               (         main.asm):00033                 clra
0E22 C617             (         main.asm):00034                 ldb #23
0E24 17010A           (         main.asm):00035                 lbsr curspos
0E27 CE0E7C           (         main.asm):00036                 ldu #line2
0E2A 1700EC           (         main.asm):00037                 lbsr printline ; Status line two
0E2D 1700E9           (         main.asm):00038                 lbsr printline ; Status line two
0E30 1700E6           (         main.asm):00039                 lbsr printline ; Status line two
                      (         main.asm):00040         
                      (         main.asm):00041                 * Draw initial content of content area
0E33 170156           (         main.asm):00042                 lbsr vlines
0E36 170162           (         main.asm):00043                 lbsr hlines
                      (         main.asm):00044         
                      (         main.asm):00045                 * Idle loop
0E39 17010A           (         main.asm):00046         loop@   lbsr keycheck
0E3C 8108             (         main.asm):00047                 cmpa #8
0E3E 2605             (         main.asm):00048                 bne notr@
0E40 0A04             (         main.asm):00049                 dec origin
0E42 170051           (         main.asm):00050                 lbsr drawframe
0E45                  (         main.asm):00051         notr@
0E45 8109             (         main.asm):00052                 cmpa #9
0E47 2605             (         main.asm):00053                 bne notl@
0E49 0C04             (         main.asm):00054                 inc origin
0E4B 170048           (         main.asm):00055                 lbsr drawframe
0E4E                  (         main.asm):00056         notl@
0E4E 810A             (         main.asm):00057                 cmpa #10
0E50 2605             (         main.asm):00058                 bne notu@
0E52 0C05             (         main.asm):00059                 inc origin+1
0E54 17003F           (         main.asm):00060                 lbsr drawframe
0E57                  (         main.asm):00061         notu@
0E57 815E             (         main.asm):00062                 cmpa #94
0E59 2605             (         main.asm):00063                 bne notd@
0E5B 0A05             (         main.asm):00064                 dec origin+1
0E5D 170036           (         main.asm):00065                 lbsr drawframe
0E60                  (         main.asm):00066         notd@
0E60 20D7             (         main.asm):00067                 bra loop@
                      (         main.asm):00068         
0E62 537461747573206C (         main.asm):00069         line1   fcs /Status line one goes here /
     696E65206F6E6520
     676F657320686572
     65A0
0E7C 537461747573206C (         main.asm):00070         line2   fcs /Status line two goes here /
     696E652074776F20
     676F657320686572
     65A0
                      (         main.asm):00071         
                      (         main.asm):00072         * Draw frame
0E96                  (         main.asm):00073         drawframe
0E96 13               (         main.asm):00074                 sync
0E97 17006F           (         main.asm):00075                 lbsr clrcontent
0E9A 1700EF           (         main.asm):00076                 lbsr vlines
0E9D 1700FB           (         main.asm):00077                 lbsr hlines
0EA0 39               (         main.asm):00078                 rts
                      (         main.asm):00079         
                      (         main.asm):00080         * Initialize graphics
0EA1                  (         main.asm):00081         initgfx
                      (         main.asm):00082                 * Wait for VSYNC
0EA1 13               (         main.asm):00083                 sync
                      (         main.asm):00084         
                      (         main.asm):00085                 * Set all palettes to black
0EA2 4F               (         main.asm):00086                 clra
0EA3 5F               (         main.asm):00087                 clrb
0EA4 FDFFB0           (         main.asm):00088                 std $ffb0
0EA7 FDFFB2           (         main.asm):00089                 std $ffb2
0EAA FDFFB4           (         main.asm):00090                 std $ffb4
0EAD FDFFB6           (         main.asm):00091                 std $ffb6
0EB0 FDFFB8           (         main.asm):00092                 std $ffb8
0EB3 FDFFBA           (         main.asm):00093                 std $ffba
0EB6 FDFFBC           (         main.asm):00094                 std $ffbc
0EB9 FDFFBE           (         main.asm):00095                 std $ffbe
                      (         main.asm):00096         
                      (         main.asm):00097                 * Set graphics mode to 80 columns
0EBC 7FFF9C           (         main.asm):00098                 clr $ff9c
0EBF 864E             (         main.asm):00099                 lda #$4e
0EC1 B7FF90           (         main.asm):00100                 sta $ff90
0EC4 CC031F           (         main.asm):00101                 ldd #$031f
0EC7 FDFF98           (         main.asm):00102                 std $ff98
                      (         main.asm):00103         
                      (         main.asm):00104                 * Set graphics memory
0ECA 8636             (         main.asm):00105                 lda #$36
0ECC B7FFA2           (         main.asm):00106                 sta $ffa2
0ECF CCD800           (         main.asm):00107                 ldd #$d800
0ED2 FDFF9D           (         main.asm):00108                 std $ff9d
                      (         main.asm):00109         
                      (         main.asm):00110                 * Clear the screen
0ED5 170011           (         main.asm):00111                 lbsr clrstatus1
0ED8 17002E           (         main.asm):00112                 lbsr clrcontent
0EDB 17001B           (         main.asm):00113                 lbsr clrstatus2
                      (         main.asm):00114         
                      (         main.asm):00115                 * Set palettes for text
0EDE C61B             (         main.asm):00116                 ldb #27         ; cyan
0EE0 F7FFB8           (         main.asm):00117                 stb $ffb8
0EE3 C636             (         main.asm):00118                 ldb #54         ; amber
0EE5 F7FFB9           (         main.asm):00119                 stb $ffb9
0EE8 39               (         main.asm):00120                 rts
                      (         main.asm):00121         
                      (         main.asm):00122         * Clear status area one
0EE9                  (         main.asm):00123         clrstatus1
0EE9 8E4000           (         main.asm):00124                 ldx #SCREEN
0EEC CC2008           (         main.asm):00125                 ldd #$2008
0EEF ED81             (         main.asm):00126         loop@   std ,x++
0EF1 ED81             (         main.asm):00127                 std ,x++
0EF3 8C4140           (         main.asm):00128                 cmpx #SCREEN+2*160
0EF6 26F7             (         main.asm):00129                 bne loop@
0EF8 39               (         main.asm):00130                 rts
                      (         main.asm):00131         
                      (         main.asm):00132         * Clear status area two
0EF9                  (         main.asm):00133         clrstatus2
0EF9 8E4E60           (         main.asm):00134                 ldx #SCREEN+23*160
0EFC CC2008           (         main.asm):00135                 ldd #$2008
0EFF ED81             (         main.asm):00136         loop@   std ,x++
0F01 ED81             (         main.asm):00137                 std ,x++
0F03 8C4F00           (         main.asm):00138                 cmpx #SCREEN+24*160
0F06 26F7             (         main.asm):00139                 bne loop@
0F08 39               (         main.asm):00140                 rts
                      (         main.asm):00141         
                      (         main.asm):00142         * Clear just the content area
0F09                  (         main.asm):00143         clrcontent
0F09 8E4140           (         main.asm):00144                 ldx #SCREEN+2*160
0F0C CC2000           (         main.asm):00145                 ldd #$2000
0F0F ED81             (         main.asm):00146         loop@   std ,x++
0F11 ED81             (         main.asm):00147                 std ,x++
0F13 8C4DC0           (         main.asm):00148                 cmpx #SCREEN+22*160
0F16 26F7             (         main.asm):00149                 bne loop@
0F18 39               (         main.asm):00150                 rts
                      (         main.asm):00151         
                      (         main.asm):00152         * Display a line of text
0F19                  (         main.asm):00153         printline
0F19 3440             (         main.asm):00154                 pshs u
0F1B 109E00           (         main.asm):00155                 ldy textptr
0F1E A6C0             (         main.asm):00156         loop@   lda ,u+
0F20 A7A1             (         main.asm):00157                 sta ,y++
0F22 2AFA             (         main.asm):00158                 bpl loop@
0F24 109F00           (         main.asm):00159         exit@   sty textptr
0F27 35C0             (         main.asm):00160                 puls u,pc
                      (         main.asm):00161         
                      (         main.asm):00162         * Position cursor to next line
0F29 DC02             (         main.asm):00163         crlf    ldd cursor
0F2B 4F               (         main.asm):00164                 clra
0F2C 5C               (         main.asm):00165                 incb
0F2D 170001           (         main.asm):00166                 lbsr curspos
0F30 39               (         main.asm):00167                 rts
                      (         main.asm):00168         
                      (         main.asm):00169         * Position cursor
                      (         main.asm):00170         *
                      (         main.asm):00171         * Entry:
                      (         main.asm):00172         *       A is column 0 to 79
                      (         main.asm):00173         *       B is row 0 to 23
0F31                  (         main.asm):00174         curspos
0F31 DD02             (         main.asm):00175                 std cursor
0F33 8650             (         main.asm):00176                 lda #80
0F35 3D               (         main.asm):00177                 mul
0F36 DB02             (         main.asm):00178                 addb cursor
0F38 8920             (         main.asm):00179                 adca #SCREEN/512
0F3A 58               (         main.asm):00180                 aslb
0F3B 49               (         main.asm):00181                 rola
0F3C DD00             (         main.asm):00182                 std textptr
0F3E 39               (         main.asm):00183                 rts
                      (         main.asm):00184         
                      (         main.asm):00185         * Is point visible in viewport?
                      (         main.asm):00186         *
                      (         main.asm):00187         * Entry:
                      (         main.asm):00188         *       A is column in viewport
                      (         main.asm):00189         *       B is row in viewport
                      (         main.asm):00190         * Calling sequence:
                      (         main.asm):00191         *       lbsr isvisible
                      (         main.asm):00192         *       bcc notvisible
                      (         main.asm):00193         *       bcs visible
0F3F                  (         main.asm):00194         isvisible
0F3F 814F             (         main.asm):00195                 cmpa #79
0F41 2202             (         main.asm):00196                 bhi no@
0F43 C114             (         main.asm):00197                 cmpb #20
0F45 39               (         main.asm):00198         no@     rts
                      (         main.asm):00199         
                      (         main.asm):00200         * Poll keyboard
0F46                  (         main.asm):00201         keycheck
0F46 AD9FA000         (         main.asm):00202                 jsr [$a000]
0F4A 8103             (         main.asm):00203                 cmpa #3         ; BREAK quit to BASIC
0F4C 2603             (         main.asm):00204                 bne exit@
0F4E 170001           (         main.asm):00205                 lbsr reset
0F51 39               (         main.asm):00206         exit@   rts
                      (         main.asm):00207         
                      (         main.asm):00208         * Exit to BASIC
0F52                  (         main.asm):00209         reset
0F52 4F               (         main.asm):00210                 clra            ; hard reset to RSDOS
0F53 1F8B             (         main.asm):00211                 tfr a,dp
0F55 8688             (         main.asm):00212                 lda #$88
0F57 B7FF90           (         main.asm):00213                 sta $ff90       ; turn off MMU
0F5A 7FFFD8           (         main.asm):00214                 clr $ffd8       ; slow CPU
0F5D B7FFDE           (         main.asm):00215                 sta $ffde       ; turn on ROMs
0F60 0F71             (         main.asm):00216                 clr $0071
0F62 6E9FFFFE         (         main.asm):00217                 jmp [$fffe]
                      (         main.asm):00218         
                      (         main.asm):00219         * List of horizontal lines
0F66                  (         main.asm):00220         hlist
0F66 50142F           (         main.asm):00221          fcb 80,20,47
0F69 501D1B           (         main.asm):00222          fcb 80,29,27
0F6C 731D0C           (         main.asm):00223          fcb 115,29,12
0F6F 60290B           (         main.asm):00224          fcb 96,41,11
0F72 73290C           (         main.asm):00225          fcb 115,41,12
0F75 60361F           (         main.asm):00226          fcb 96,54,31
0F78 FF               (         main.asm):00227          fcb $ff
                      (         main.asm):00228         
                      (         main.asm):00229         * List of vertical lines
0F79                  (         main.asm):00230         vlist
0F79 50140A           (         main.asm):00231          fcb 80,20,10
0F7C 60290E           (         main.asm):00232          fcb 96,41,14
0F7F 6A1D0D           (         main.asm):00233          fcb 106,29,13
0F82 731D0D           (         main.asm):00234          fcb 115,29,13
0F85 7E140A           (         main.asm):00235          fcb 126,20,10
0F88 7E290E           (         main.asm):00236          fcb 126,41,14
0F8B FF               (         main.asm):00237          fcb $ff
                      (         main.asm):00238         
                      (         main.asm):00239         * Draw all vertical lines visible in viewport
0F8C                  (         main.asm):00240         vlines
0F8C 338CEA           (         main.asm):00241                 leau vlist,pcr
0F8F 170018           (         main.asm):00242         loop@   lbsr vline
0F92 3343             (         main.asm):00243                 leau 3,u
0F94 A6C4             (         main.asm):00244                 lda ,u
0F96 81FF             (         main.asm):00245                 cmpa #$ff
0F98 26F5             (         main.asm):00246                 bne loop@
0F9A 39               (         main.asm):00247                 rts
                      (         main.asm):00248         
                      (         main.asm):00249         * Draw all horizontal lines visible in viewport
0F9B                  (         main.asm):00250         hlines
0F9B 338CC8           (         main.asm):00251                 leau hlist,pcr
0F9E 170046           (         main.asm):00252         loop@   lbsr hline
0FA1 3343             (         main.asm):00253                 leau 3,u
0FA3 A6C4             (         main.asm):00254                 lda ,u
0FA5 81FF             (         main.asm):00255                 cmpa #$ff
0FA7 26F5             (         main.asm):00256                 bne loop@
0FA9 39               (         main.asm):00257                 rts
                      (         main.asm):00258         
                      (         main.asm):00259         * Draw vertical line, clip to viewport
0FAA                  (         main.asm):00260         vline
0FAA ECC4             (         main.asm):00261                 ldd ,u
0FAC 9004             (         main.asm):00262                 suba origin     ; map to viewport
0FAE D005             (         main.asm):00263                 subb origin+1
0FB0 DD06             (         main.asm):00264                 std coords      ; x1, y1
0FB2 EB42             (         main.asm):00265                 addb 2,u        ; y2 = y1 + length
0FB4 DD08             (         main.asm):00266                 std coords+2    ; x2, y2
0FB6 17FF86           (         main.asm):00267                 lbsr isvisible  ; endpoint visible?
0FB9 2507             (         main.asm):00268                 bcs okay@
0FBB DC06             (         main.asm):00269                 ldd coords
0FBD 17FF7F           (         main.asm):00270                 lbsr isvisible  ; endpoint visible?
0FC0 2424             (         main.asm):00271                 bcc xvline      ; neither visible, forget it
0FC2                  (         main.asm):00272         okay@
0FC2 A642             (         main.asm):00273                 lda 2,u         ; length of line
0FC4 970A             (         main.asm):00274                 sta coords+4
0FC6                  (         main.asm):00275         loop@
0FC6 DC06             (         main.asm):00276                 ldd coords      ; x1, y1
0FC8 17FF74           (         main.asm):00277                 lbsr isvisible
0FCB 2413             (         main.asm):00278                 bcc skip@       ; if point not visible, skip it
0FCD 5C               (         main.asm):00279                 incb
0FCE 5C               (         main.asm):00280                 incb
0FCF 17FF5F           (         main.asm):00281                 lbsr curspos
0FD2 9E00             (         main.asm):00282                 ldx textptr     ; where to put next point
0FD4 867C             (         main.asm):00283                 lda #'|'
0FD6 E684             (         main.asm):00284                 ldb ,x          ; is there a character there already?
0FD8 C120             (         main.asm):00285                 cmpb #$20
0FDA 2702             (         main.asm):00286                 beq setpoint@
0FDC 862B             (         main.asm):00287                 lda #'+'        ; if so, put a + there instead of |
0FDE                  (         main.asm):00288         setpoint@
0FDE A784             (         main.asm):00289                 sta ,x          ; draw next point
0FE0                  (         main.asm):00290         skip@
0FE0 0C07             (         main.asm):00291                 inc coords+1    ; y1 += 1
0FE2 0A0A             (         main.asm):00292                 dec coords+4    ; length--
0FE4 26E0             (         main.asm):00293                 bne loop@
0FE6 39               (         main.asm):00294         xvline  rts
                      (         main.asm):00295         
                      (         main.asm):00296         * Draw horizontal line, clip to viewport
0FE7                  (         main.asm):00297         hline
0FE7 ECC4             (         main.asm):00298                 ldd ,u
0FE9 9004             (         main.asm):00299                 suba origin     ; map to viewport
0FEB D005             (         main.asm):00300                 subb origin+1
0FED DD06             (         main.asm):00301                 std coords      ; x1, y1
0FEF AB42             (         main.asm):00302                 adda 2,u        ; x2 = x1 + length
0FF1 DD08             (         main.asm):00303                 std coords+2    ; x2, y2
0FF3 17FF49           (         main.asm):00304                 lbsr isvisible  ; endpoint visible?
0FF6 2507             (         main.asm):00305                 bcs okay@
0FF8 DC06             (         main.asm):00306                 ldd coords
0FFA 17FF42           (         main.asm):00307                 lbsr isvisible  ; endpoint visible?
0FFD 2424             (         main.asm):00308                 bcc xhline      ; neither visible, forget it
0FFF                  (         main.asm):00309         okay@
0FFF A642             (         main.asm):00310                 lda 2,u         ; length of line
1001 970A             (         main.asm):00311                 sta coords+4
1003                  (         main.asm):00312         loop@
1003 DC06             (         main.asm):00313                 ldd coords      ; x1, y1
1005 17FF37           (         main.asm):00314                 lbsr isvisible
1008 2413             (         main.asm):00315                 bcc skip@       ; if point not visible, skip it
100A 5C               (         main.asm):00316                 incb
100B 5C               (         main.asm):00317                 incb
100C 17FF22           (         main.asm):00318                 lbsr curspos
100F 9E00             (         main.asm):00319                 ldx textptr     ; where to put next point
1011 862D             (         main.asm):00320                 lda #'-'
1013 E684             (         main.asm):00321                 ldb ,x          ; is there a character there already?
1015 C120             (         main.asm):00322                 cmpb #$20
1017 2702             (         main.asm):00323                 beq setpoint@
1019 862B             (         main.asm):00324                 lda #'+'        ; if so, put a + there instead of -
101B                  (         main.asm):00325         setpoint@
101B A784             (         main.asm):00326                 sta ,x          ; draw next point
101D                  (         main.asm):00327         skip@
101D 0C06             (         main.asm):00328                 inc coords      ; x1 += 1
101F 0A0A             (         main.asm):00329                 dec coords+4    ; length--
1021 26E0             (         main.asm):00330                 bne loop@
1023 39               (         main.asm):00331         xhline  rts
                      (         main.asm):00332         
                      (         main.asm):00333                 end start
